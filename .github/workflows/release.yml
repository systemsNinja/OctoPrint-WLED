name: Release
on:
  release:
    types: [published]

jobs:
  build:
    name: ğŸ”¨ Build distribution
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ— Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: ğŸ— Set up Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ— Install build dependencies
        run: |
          python -m pip install wheel octoprint --user
          npm install -g npm@latest
          npm install
      
      - name: ğŸ”¨ Build frontend code in release mode
        run: |
          npm run release
      
      - name: ğŸ”¨ Commit changes to make versioneer happy
        uses: EndBug/add-and-commit@v9
        with:
          push: false
          branch: main
      
      - name: ğŸ”¨ Build a source zip
        run: |
          python setup.py sdist --formats=zip
      
      - name: ğŸšš rename to sdist.zip
        run: |
          mv dist/*.zip dist/sdist.zip
      
      - name: â¬† Upload build result
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  upload-asset:
    name: ğŸ“¦ Upload asset to release
    runs-on: ubuntu-latest
    needs:
      - build
    permissions:
      contents: write
    steps:
      - name: â¬‡ Download build result
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: ğŸšš Rename to release.zip
        run: |
          cp dist/sdist.zip release.zip

      - name: ğŸ“¦ Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: release.zip